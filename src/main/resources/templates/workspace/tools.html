<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools - My Workspace</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <style>
        .tools-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        .tool-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: border-color 0.2s;
        }

        .tool-card:hover {
            border-color: var(--accent-color);
        }

        .tool-card-icon {
            width: 40px;
            height: 40px;
            background-color: var(--bg-tertiary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .tool-card-icon svg {
            width: 20px;
            height: 20px;
            color: var(--accent-color);
        }

        .tool-card-info {
            flex: 1;
            min-width: 0;
        }

        .tool-card-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-card-name .badge {
            font-size: 0.7rem;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .badge.mcp {
            background-color: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }

        .badge.custom {
            background-color: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }

        .tool-card-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tool-card-server {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .tool-card-toggle {
            flex-shrink: 0;
        }

        .tool-card-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
            cursor: pointer;
        }

        .empty-tools {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-tools svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-tools p {
            font-size: 0.95rem;
        }

        .tools-info {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            margin-top: 16px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>Tools</h1>
            <a href="/workspace" class="back-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Back to Workspace
            </a>
        </header>

        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-value" id="totalToolCount">--</div>
                <div class="stat-label">Total Tools</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="enabledCount">--</div>
                <div class="stat-label">Enabled</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="mcpCount">--</div>
                <div class="stat-label">MCP Tools</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="customCount">--</div>
                <div class="stat-label">Custom Tools</div>
            </div>
        </div>

        <div class="tools-info">
            Enable or disable individual tools below. Disabled tools will not be available to the AI during chat.
            Tool preferences are saved per-browser and apply immediately to new conversations.
        </div>

        <div style="display:flex; align-items:center; gap:12px; margin-top:16px;">
            <label for="serverFilter" style="font-size:0.9rem; color:var(--text-secondary);">Filter by Server:</label>
            <select id="serverFilter" style="padding:8px 12px; background-color:var(--bg-tertiary); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); font-size:0.9rem;">
                <option value="">All Servers</option>
            </select>
            <button class="action-btn" id="bulkEnableBtn" style="display:none;">Enable All</button>
            <button class="action-btn" id="bulkDisableBtn" style="display:none;">Disable All</button>
        </div>

        <div class="tools-grid" id="toolsGrid">
            <div class="empty-tools">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                </svg>
                <p>Loading tools...</p>
            </div>
        </div>
    </div>

    <script th:src="@{/js/admin-theme.js}"></script>
    <script th:src="@{/js/admin-toast.js}"></script>
    <script>
        (function() {
            var toolPreferences = {};
            try {
                var saved = localStorage.getItem('toolPreferences');
                if (saved) toolPreferences = JSON.parse(saved);
            } catch(e) {}

            function isToolEnabled(toolId) {
                return toolPreferences[toolId] === undefined ? true : toolPreferences[toolId];
            }

            function savePreferences() {
                try { localStorage.setItem('toolPreferences', JSON.stringify(toolPreferences)); } catch(e) {}
            }

            function createToolCard(tool) {
                var card = document.createElement('div');
                card.className = 'tool-card';
                card.dataset.id = tool.id;

                var icon = document.createElement('div');
                icon.className = 'tool-card-icon';
                icon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>';

                var info = document.createElement('div');
                info.className = 'tool-card-info';

                var nameRow = document.createElement('div');
                nameRow.className = 'tool-card-name';
                var nameText = document.createTextNode(tool.displayName || tool.name);
                nameRow.appendChild(nameText);
                var badge = document.createElement('span');
                badge.className = 'badge ' + (tool.type === 'MCP' ? 'mcp' : 'custom');
                badge.textContent = tool.type;
                nameRow.appendChild(badge);
                info.appendChild(nameRow);

                if (tool.description) {
                    var desc = document.createElement('div');
                    desc.className = 'tool-card-desc';
                    desc.textContent = tool.description;
                    info.appendChild(desc);
                }
                if (tool.mcpServerName) {
                    var server = document.createElement('div');
                    server.className = 'tool-card-server';
                    server.textContent = 'Server: ' + tool.mcpServerName;
                    info.appendChild(server);
                }

                var toggle = document.createElement('div');
                toggle.className = 'tool-card-toggle';
                var cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.dataset.toolId = tool.id;
                cb.checked = isToolEnabled(tool.id);
                toggle.appendChild(cb);

                card.appendChild(icon);
                card.appendChild(info);
                card.appendChild(toggle);

                card.dataset.serverName = tool.mcpServerName || '';
                return card;
            }

            fetch('/api/chat/available-tools')
                .then(function(r) { return r.ok ? r.json() : []; })
                .then(function(tools) {
                    var grid = document.getElementById('toolsGrid');
                    var mcpTools = tools.filter(function(t) { return t.type === 'MCP'; });
                    var customTools = tools.filter(function(t) { return t.type !== 'MCP'; });
                    var enabledTools = tools.filter(function(t) { return isToolEnabled(t.id); });

                    document.getElementById('totalToolCount').textContent = tools.length;
                    document.getElementById('enabledCount').textContent = enabledTools.length;
                    document.getElementById('mcpCount').textContent = mcpTools.length;
                    document.getElementById('customCount').textContent = customTools.length;

                    grid.textContent = '';

                    if (tools.length === 0) {
                        var empty = document.createElement('div');
                        empty.className = 'empty-tools';
                        var p = document.createElement('p');
                        p.textContent = 'No tools available. MCP tools are configured by your administrator.';
                        empty.appendChild(p);
                        grid.appendChild(empty);
                        return;
                    }

                    tools.forEach(function(tool) {
                        var card = createToolCard(tool);
                        grid.appendChild(card);
                    });

                    // Populate server filter dropdown
                    var serverNames = [];
                    tools.forEach(function(t) {
                        if (t.mcpServerName && serverNames.indexOf(t.mcpServerName) === -1) {
                            serverNames.push(t.mcpServerName);
                        }
                    });
                    serverNames.sort();
                    var filterSelect = document.getElementById('serverFilter');
                    serverNames.forEach(function(name) {
                        var opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        filterSelect.appendChild(opt);
                    });

                    function filterCards() {
                        var selected = filterSelect.value;
                        var cards = grid.querySelectorAll('.tool-card');
                        cards.forEach(function(card) {
                            if (!selected || card.dataset.serverName === selected) {
                                card.style.display = '';
                            } else {
                                card.style.display = 'none';
                            }
                        });
                        // Show bulk buttons when a server is selected
                        document.getElementById('bulkEnableBtn').style.display = selected ? '' : 'none';
                        document.getElementById('bulkDisableBtn').style.display = selected ? '' : 'none';
                    }

                    function bulkToggle(enabled) {
                        var cards = grid.querySelectorAll('.tool-card');
                        cards.forEach(function(card) {
                            if (card.style.display !== 'none') {
                                var cb = card.querySelector('input[type="checkbox"]');
                                if (cb && cb.dataset.toolId) {
                                    cb.checked = enabled;
                                    toolPreferences[cb.dataset.toolId] = enabled;
                                }
                            }
                        });
                        savePreferences();
                        var en = tools.filter(function(t) { return isToolEnabled(t.id); });
                        document.getElementById('enabledCount').textContent = en.length;
                        if (window.showToast) window.showToast(enabled ? 'All visible tools enabled' : 'All visible tools disabled');
                    }

                    filterSelect.addEventListener('change', filterCards);
                    document.getElementById('bulkEnableBtn').addEventListener('click', function() { bulkToggle(true); });
                    document.getElementById('bulkDisableBtn').addEventListener('click', function() { bulkToggle(false); });

                    grid.addEventListener('change', function(e) {
                        var cb = e.target;
                        if (cb.dataset && cb.dataset.toolId) {
                            toolPreferences[cb.dataset.toolId] = cb.checked;
                            savePreferences();
                            var en = tools.filter(function(t) { return isToolEnabled(t.id); });
                            document.getElementById('enabledCount').textContent = en.length;
                            if (window.showToast) window.showToast(cb.checked ? 'Tool enabled' : 'Tool disabled');
                        }
                    });
                })
                .catch(function(err) {
                    console.error('Failed to load tools:', err);
                    var grid = document.getElementById('toolsGrid');
                    grid.textContent = '';
                    var p = document.createElement('p');
                    p.textContent = 'Failed to load tools.';
                    grid.appendChild(p);
                });
        })();
    </script>
</body>
</html>
