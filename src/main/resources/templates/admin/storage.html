<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Storage - Admin Portal</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .admin-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .admin-header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent-color);
            text-decoration: none;
            font-size: 0.95rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .back-link svg {
            width: 18px;
            height: 18px;
        }

        .status-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-icon.enabled {
            background-color: rgba(16, 163, 127, 0.2);
            color: var(--accent-color);
        }

        .status-icon.disabled {
            background-color: rgba(156, 163, 175, 0.2);
            color: var(--text-secondary);
        }

        .status-icon svg {
            width: 24px;
            height: 24px;
        }

        .status-text h3 {
            margin: 0 0 4px 0;
            font-size: 1.1rem;
        }

        .status-text p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.enabled {
            background-color: rgba(16, 163, 127, 0.2);
            color: var(--accent-color);
        }

        .status-badge.disabled {
            background-color: rgba(156, 163, 175, 0.2);
            color: var(--text-secondary);
        }

        .status-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
        }

        .config-section {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            font-size: 1.2rem;
            margin: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .form-group input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--bg-hover);
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .alert.success {
            background-color: rgba(16, 163, 127, 0.2);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        .alert.error {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .alert.info {
            background-color: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .info-box {
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .info-box h4 {
            margin: 0 0 8px 0;
            font-size: 0.95rem;
        }

        .info-box p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>Document Storage</h1>
            <div class="header-nav">
                <a href="/admin" class="back-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Back to Admin
                </a>
                <a href="/" class="back-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Chat
                </a>
            </div>
        </header>

        <div id="alertContainer"></div>

        <div class="status-card">
            <div class="status-info">
                <div class="status-icon" id="statusIcon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                    </svg>
                </div>
                <div class="status-text">
                    <h3 id="statusTitle">S3 Document Storage</h3>
                    <p id="statusDescription">Loading configuration...</p>
                </div>
            </div>
            <span class="status-badge disabled" id="statusBadge">
                <span class="dot"></span>
                <span id="statusBadgeText">Loading</span>
            </span>
        </div>

        <div class="info-box">
            <h4>About Document Storage</h4>
            <p>
                S3 storage allows users to download their original uploaded documents. Without S3 configured,
                documents are only processed for embeddings and the originals are discarded.
                You can use AWS S3, MinIO, or any S3-compatible object storage service.
            </p>
        </div>

        <div class="config-section">
            <div class="section-header">
                <h2>S3 Configuration</h2>
                <div class="toggle-container">
                    <span style="font-size: 0.9rem;">Enable Storage</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="storageEnabled" onchange="toggleStorage()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <form id="storageForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="bucketName">Bucket Name *</label>
                        <input type="text" id="bucketName" placeholder="my-document-bucket" required>
                        <small>The S3 bucket where documents will be stored</small>
                    </div>
                    <div class="form-group">
                        <label for="region">Region *</label>
                        <input type="text" id="region" placeholder="us-east-1" required>
                        <small>AWS region or equivalent for S3-compatible services</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="endpointUrl">Custom Endpoint URL (optional)</label>
                    <input type="text" id="endpointUrl" placeholder="https://s3.amazonaws.com">
                    <small>Leave empty for AWS S3. Set for MinIO or other S3-compatible services.</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="accessKey">Access Key ID *</label>
                        <input type="password" id="accessKey" placeholder="Enter access key">
                        <small>Leave empty to keep existing key</small>
                    </div>
                    <div class="form-group">
                        <label for="secretKey">Secret Access Key *</label>
                        <input type="password" id="secretKey" placeholder="Enter secret key">
                        <small>Leave empty to keep existing key</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="pathPrefix">Path Prefix (optional)</label>
                        <input type="text" id="pathPrefix" placeholder="documents/">
                        <small>Optional folder path within the bucket</small>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="pathStyleAccess">
                            <label for="pathStyleAccess">Use Path-Style Access</label>
                        </div>
                        <small>Enable for MinIO and some S3-compatible services</small>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="testConnection()">
                        Test Connection
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Save Configuration
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.setAttribute('data-theme', savedTheme);

        let currentConfig = null;

        // Load configuration on page load
        document.addEventListener('DOMContentLoaded', loadConfiguration);

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function loadConfiguration() {
            fetch('/api/admin/storage')
                .then(response => response.json())
                .then(data => {
                    currentConfig = data;
                    updateUI(data);
                })
                .catch(error => {
                    console.error('Error loading config:', error);
                    showAlert('Failed to load configuration', 'error');
                });
        }

        function updateUI(config) {
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusDescription = document.getElementById('statusDescription');
            const statusBadge = document.getElementById('statusBadge');
            const statusBadgeText = document.getElementById('statusBadgeText');
            const enabledToggle = document.getElementById('storageEnabled');

            if (config.storageActive) {
                statusIcon.className = 'status-icon enabled';
                statusTitle.textContent = 'S3 Storage Active';
                statusDescription.textContent = 'Documents will be stored in S3 and available for download';
                statusBadge.className = 'status-badge enabled';
                statusBadgeText.textContent = 'Active';
            } else if (config.configured && config.enabled) {
                statusIcon.className = 'status-icon disabled';
                statusTitle.textContent = 'Configuration Incomplete';
                statusDescription.textContent = 'Storage is enabled but configuration may be invalid';
                statusBadge.className = 'status-badge disabled';
                statusBadgeText.textContent = 'Error';
            } else {
                statusIcon.className = 'status-icon disabled';
                statusTitle.textContent = 'S3 Storage Disabled';
                statusDescription.textContent = 'Documents are processed for embeddings only';
                statusBadge.className = 'status-badge disabled';
                statusBadgeText.textContent = 'Disabled';
            }

            // Update form fields
            enabledToggle.checked = config.enabled || false;
            document.getElementById('bucketName').value = config.bucketName || '';
            document.getElementById('region').value = config.region || '';
            document.getElementById('endpointUrl').value = config.endpointUrl || '';
            document.getElementById('pathPrefix').value = config.pathPrefix || '';
            document.getElementById('pathStyleAccess').checked = config.pathStyleAccess || false;

            // Clear password fields but show indicator if keys exist
            document.getElementById('accessKey').placeholder = config.hasAccessKey ? '(key configured)' : 'Enter access key';
            document.getElementById('secretKey').placeholder = config.hasSecretKey ? '(key configured)' : 'Enter secret key';
        }

        function toggleStorage() {
            const enabled = document.getElementById('storageEnabled').checked;
            const endpoint = enabled ? '/api/admin/storage/enable' : '/api/admin/storage/disable';

            fetch(endpoint, { method: 'POST' })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        showAlert(result.message || result.error, 'error');
                        document.getElementById('storageEnabled').checked = !enabled;
                    } else {
                        showAlert(enabled ? 'Storage enabled' : 'Storage disabled', 'success');
                        loadConfiguration();
                    }
                })
                .catch(error => {
                    console.error('Error toggling storage:', error);
                    showAlert('Failed to toggle storage', 'error');
                    document.getElementById('storageEnabled').checked = !enabled;
                });
        }

        function testConnection() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Testing...';

            const data = getFormData();

            fetch('/api/admin/storage/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Connection successful!', 'success');
                } else {
                    showAlert(result.message || 'Connection failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error testing connection:', error);
                showAlert('Failed to test connection', 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'Test Connection';
            });
        }

        document.getElementById('storageForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const data = getFormData();

            fetch('/api/admin/storage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    showAlert(result.message || result.error, 'error');
                } else {
                    showAlert('Configuration saved successfully', 'success');
                    loadConfiguration();
                }
            })
            .catch(error => {
                console.error('Error saving config:', error);
                showAlert('Failed to save configuration', 'error');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Configuration';
            });
        });

        function getFormData() {
            return {
                bucketName: document.getElementById('bucketName').value,
                region: document.getElementById('region').value,
                endpointUrl: document.getElementById('endpointUrl').value || null,
                pathPrefix: document.getElementById('pathPrefix').value || null,
                pathStyleAccess: document.getElementById('pathStyleAccess').checked,
                accessKey: document.getElementById('accessKey').value || null,
                secretKey: document.getElementById('secretKey').value || null
            };
        }
    </script>
</body>
</html>
